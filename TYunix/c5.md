# Unix独習への近道 第5章
[全体目次へ戻る](index.md)

## 5章 Web開発やクラウド利用に不可欠なリモート操作とセキュアな接続
### TCP/IPを使ってファイル転送・インターネット上の情報収集を行う
- TCP/IPの4階層モデルと対応する通信プロトコル

| TCP/IP階層モデル             | プロトコル                 |
|:---------------------------- |:-------------------------- |
| アプリケーション層           | TELNET, FTP, SSH, HTTPなど |
| トランスポート層             | TCP, UDP                   |
| インターネット層             | IP, ICMP, ARPなど          |
| ネットワークインタフェース層 | Ethernet, Wi-Fiなど        |

#### 古典的なネットワークコマンド
- `ftp`: 対話型ファイル転送コマンド
  + TCP上のファイル転送プロトコル(FTP)を利用
  + 通信内容を平文で送るので、セキュリティが低い→近年は`ftps`(SSL暗号化)や`sftp`(SSH暗号化)が用いられる
  + `vsftpd`: ftpサービスのデーモンとして標準となっている
  + `tftp`: UDPを使って`ftp`よりも手早くファイルを転送する。安定性が高いネットワークで活用できる

- `telnet`: ネットワーク上のホストに接続して操作できる、端末ソフトウェア
  + 通信は平文で行われるので、端末としての役割は`ssh`などに譲っている
  + TCPを用いる任意のポートに接続できるので、汎用TCPクライアントとして活用できる

- `wget`: インターネット上のデータを手早くダウンロードするのに便利なコマンド
  + HTTP/HTTPS/FTPプロトコル、basic/digest/NTLM認証に対応
  + `-r`: 指定パス配下を再帰的に取得
  + `-l`: 再帰取得の深さを制限
  + `-A`/`-R`: 指定した拡張子のファイルのみ/以外取得する
  + `--accept-regex`/`--reject-regex`: パスが正規表現にマッチするファイルのみ/以外を取得
  + `-N`: 更新されたファイルのみを取得
  + `-c`: 前回転送が途中で停止したダウンロードを再開
  + `--http-user`/`--http-password`: 認証情報を設定

- `curl`: より多くのプロトコルに対応し、データのアップロードも可能な通信クライアント
  + ダウンロードしたデータをファイルに保存するには`-o [filename]`を指定する
  + `--digest`や`--basic`で認証を利用することができる。認証情報は`-u`のあとに記述


### sshの基本
- `ssh`: ネットワーク上の他のホストに接続するためのプロトコル。通信内容は暗号化される
  + 接続: `ssh ([ユーザー名]@)[ホスト名]` 接続元と接続先でのユーザー名が同じなら省略可能
  + 接続先が置き換えられていることを検知する仕組みがある。初回接続時に`~/.ssh/known_hosts`に接続先のフィンガープリントが登録され、同じホストに再度接続したときにフィンガープリントが変化していた場合は警告が出る
    * 問題がない場合は`ssh-keygen -R [ホスト名]`で以前の接続先情報を削除してから再度接続する

- sshの機能だけでも簡単なセッション操作が可能
  + `~ .`: 切断
  + `~ Ctrl-Z`: 現在のsshをバックグラウンドにし、ローカルのシェルに戻る
    * `fg`すればリモートのシェルに切り替えることができる
  + `~ V`/ `~ v`: ログレベルを下げる/上げる

#### 認証方式
- 公開鍵認証: 秘密鍵と公開鍵のペアを生成し、接続したいホストに事前に公開鍵を渡しておく。接続時は、鍵ペアを使ってチャレンジ・レスポンス認証を行う
  + 認証に関わる情報がネットワーク上に流れないので、最も安全
- パスワード認証
  + 利用したパスワードは暗号化されているとはいえ、ネットワーク上を流れるので安全性は少し低い
- ホストベース認証: サーバ側が接続を認めているホストのリストを持ち、接続要求がリスト内のホストから来たら接続を許す
  + 安全性は最も低い。デフォルトでは禁止となっている

- `ssh-keygen`: ssh接続で利用する鍵ペアを生成する。秘密鍵はパスフレーズで暗号化することができる
  + 公開鍵はリモートホストの`~/.ssh/authorized_keys`に配置。`scp`コマンドを使うと安全に鍵をコピーできる

- `~/.ssh/`ディレクトリにはssh接続を利用する際に使う情報が入る。安全のため、このディレクトリのパーミッションは`700`、中身のファイルのパーミッションは`600`に設定する
  + 鍵`id_rsa.pub`/`id_rsa`
  + 接続済みホストのリスト`known_hosts`
  + 承認済みのホストとその公開鍵のリスト`authorized_keys`
  + 設定ファイル`config`


### sshの少し高度な使い方
#### ポートフォワード
- ローカル転送: ローカルマシンを、リモートにあるターゲットホストへのプロキシとして使う
  + ローカルマシンからリモートマシンへssh接続してトンネルを作っておく
  + `ssh [リモートホスト] -L [転送元ポート]:[転送先ホスト]:[転送先ポート] (-g)`
    * `-g`を指定すると、ssh接続しているローカルホスト以外からのアクセスを許す
- リモート転送: プライベートネットワーク上のシステムに外部から接続できるようなトンネルを作る
  + `ssh [外部ホスト] -R [転送元ポート]:[転送先ホスト]:[転送先ポート]`
  + 使い方を間違うとセキュリティホールになる。デフォルトでは、「転送元ポート」にアクセスできるのは自分自身だけに制限されている

#### X Serverとして使う
- `-X`/`-Y`オプションを指定することでX11プロトコルのフォワードが可能
  + 利用する前に、クライアント・サーバ双方で設定が必要

```txt
# クライアント側の~/.ssh/config
ForwardX11 yes
ForwardX11Trusted yes

# サーバ側の/etc/ssh/sshd_config
# 設定後、sshdを再起動する
X11Forwarding yes
X1UseLocalhost no
```

```sh
# リモートマシンのファイルマネージャをローカルホストに表示
# -Cを指定すると通信データを圧縮する
$ ssh -YC remote-ubuntu nautilus --no-desktop &
```

#### SSHプロトコルを使ったコマンド
- `scp`: sshプロトコルを利用して、リモートマシンとの安全なファイル共有を行う

```sh
$ scp [コピー元パス] [コピー先ホスト:コピー先パス]
```

- `rsync`: リモートマシンとファイルを同期する

```sh
# -a: アーカイブモード
# -v: 詳細メッセージ
# -z: 圧縮
$ rsync -avz [元パス] [同期先パス]
```

### sshの応用
- 接続時のパスワード入力を省略するには、ホストベース認証の設定を行う
- ssh接続時の自動処理
  + `~/.ssh/environment`: sshでログイン時に追加の環境変数を設定
  + `~/.ssh/rc`: ログイン時に実行されるスクリプト。リモートの`sshd_config`で`PermitUserRC`が有効な場合のみ実行される
- `ssh-agent`: あらかじめパスフレーズを入力して秘密鍵を登録しておけば、接続の際に登録済みの鍵を自動的に取り出してくれる仕組み
  + `eval $(ssh-agent)`を実行することで有効化(無効化するには`-k`オプションをつける)
  + `ssh-agent bash`とすることで、`ssh-agent`を親プロセスとしてシェルを実行できる。シェルから`exit`すると自動的に無効化される
  + `ssh-add`で秘密鍵を登録する
- ポートフォワードでリモートマシンに接続する際は`-A`オプションをつけると秘密鍵の情報が踏み台マシンにフォワードされる
  + 踏み台マシンの秘密鍵をリモートマシンに設置する必要はない
- `ssh-copy-id`: 公開鍵をリモートマシンに`scp`して`authorized_keys`に追記する処理を一度にできる
  + 書式: `ssh-copy-id -i [公開鍵ファイル] [登録先ホスト]`

***

[前へ](c4.md) /
[全体目次へ戻る](index.md) /
[次へ](c6.md)
