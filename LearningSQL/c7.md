# 初めてのSQL 第7章
[全体目次へ戻る](index.md)

## 7章 データの生成、変換、操作
MySQLのビルトイン関数についてまとめる。ビルトイン関数によって文字列･数値･時間データを生成･変換･操作することができる。利用できるビルトイン関数の種類はデータベースベンダーによって異なるので注意が必要。

### 文字列データの操作
+ シングルクォーテーション(')を含む文字列をテーブルに挿入するには、シングルクォーテーションを2つ重ねることでエスケープする必要がある。
  - バックスラッシュ(\\)でもエスケープは可能
+ `QUOTE()`関数は、取得した文字列をシングルクォーテーションで囲み、文字列中のシングルクォーテーションをエスケープする。取得結果をエクスポートする際に利用できる。

#### 数値を返す文字列関数
データベースを扱う場合、文字列の1文字目を表すインデックスは(0ではなく)1であることに注意する。

+ `LENGTH()`関数は文字列の文字数を返す。
+ `POSITION()`関数はテーブルのある列に格納された文字列に指定した部分文字列が含まれている場合は、その開始場所を求める。
  - 引数は`('文字列' IN 列名)`のように指定する。
  - 一致がない場合は0を返す。
  - 文字列の先頭以外の指定場所以降から部分文字列を検索する`LOCATE()`という関数もある。

```sql
/* tableテーブルのhoge列に'characters'という文字列があればその開始場所を求める */
SELECT POSITION('characters' IN hoge)
FROM table;

/* hoge列の5文字目以降から'is'という文字列を探す */
SELECT LOCATE('is', hoge, 5)
FROM table;
```

+ `STRCMP()`関数は2つの文字列をとって、文字列のソート順に基づいた比較を行う。
  - 返り値は、1つ目の文字列のほうが小さければ -1 、1つ目の文字列のほうが大きければ 1 、 等しければ 0 となる。
  - 大文字と小文字の区別はしない。
+ `LIKE`や`REGEXP`は、指定したパターンに一致する場合は 1 、一致しない場合は 0 を返す関数としても使える。

```sql
/* name列の文字列が'ns'で終わる場合は1,そうでなければ0が入る列 ends_in_ns を追加する */
SELECT name, name LIKE '%ns' ends_in_ns
FROM table;
```

#### 文字列を返す文字列関数
+ `CONCAT()`関数は、引数に指定した複数の文字列を連結する。
  - 数値や時間データも指定でき、自動的に文字列に変換される。

```sql
/* tableから文字列型の列hogeとfugaを取り出し、キャプションとともに出力 */
SELECT CONCAT('hoge: ', hoge, ', fuga: ', fuga)
FROM table;
```

+ `INSERT()`関数は、ある文字列の指定した場所に別の文字列を挿入する。置き換える文字の数を指定することで置換も可能。

```sql
/* 'goodbye world'の9文字目に'cruel 'を挿入。挿入の場合は置換文字数を0にする */
SELECT INSERT('goodbye world', 9, 0, 'cruel ');
/* => 'goodbye cruel world'

/* 'goodbye world'の1文字目から7文字分を'hello'に置き換える */
SELECT INSERT('goodbye world', 1, 7, 'hello');
/* => 'hello world' */
```

+ `SUBSTRING()`関数は文字列の部分文字列を抽出する。

```sql
/* 'goodbye cruel world'の9文字目から5文字を抽出する */
SELECT SUBSTRING('goodbye cruel world', 9, 5);
/* => 'cruel' */
```

### 数値データの操作
+ 数値データに対しては、四則演算が行える。また`SIN()`、`SQRT()`、`MOD()`、`POW()`などの算術関数も使える。
+ 浮動小数点数の切り上げ、切り捨て、四捨五入を行う関数が用意されている。
  - `CEIL()`は整数への切り上げ、`FLOOR()`は整数への切り捨てを行う。
  - `ROUND()`は四捨五入を行う。さらに、第2引数に小数点以下の桁数を指定できる。
  - `TRUNCATE()`は切り捨てを行う。`FLOOR()`との違いは小数点以下の桁数を指定できる点。
  - `ROUND()`,`TRUNCATE()`の第2引数に負の数を指定すると、整数部で四捨五入･切り捨てを行う。

```sql
SELECT CEIL(77.45), FLOOR(77.45), ROUND(77.45), ROUND(77.45, 1), TRUNCATE(77.45, 1), ROUND(77.45, -1);
/* =>       78            77            77            77.5                77.4             80 */
```

+ `SIGN()`と`ABS()`はそれぞれ数値の符号と絶対値を求める。
  - `SIGN()`は引数が正の数なら 1, 負の数なら -1, 0なら 0を返す。

### 時間データの操作
#### 日付を返す時間関数
+ `DATE_ADD()`、`DATE_SUB()`関数はそれぞれ指定した日付に、ある日数･時間などを加えたり、減じたりした結果の日付を返す。
  - 第2引数に加える/減じる期間を指定する。書式は`INTERVAL ... (期間の単位)`のようにする。期間の単位は以下のようなものが使える。

|単位名  |説明|
|:-------|:---|
|`SECOND`|秒数|
|`MINUTE`|分数|
|`HOUR`  |時間|
|`DAY`   |日数|
|`MONTH` |月数|
|`YEAR`  |年数|
|`MINUTE_SECOND`|分数:秒数|
|`HOUR_SECOND`  |時間:分数:秒数|
|`YEAR_MONTH`   |年数-月数     |

```sql
SELECT DATE_ADD('2016-09-13', INTERVAL 5 DAY);
/* => '2016-09-18' */

/* idが9999である行のhoge列の日付を3時間27分11秒進める */
UPDATE table
SET hoge = DATE_ADD(hoge, INTERVAL '3:27:11' HOUR_SECOND)
WHERE id = 9999;
```

+ `LAST_DAY()`関数は、指定した日付が含まれる月の最後の日の日付を返す。

```sql
SELECT LAST_DAY('2016-09-13');
/* => '2015-9-30' */
```

+ `CONVERT_TZ()`関数は、日付をタイムゾーン間で変換する。

```sql
SELECT CONVERT_TZ('2016-09-13 22:26:00', 'Asia/Tokyo', 'UTC');
/* => '2016-09-13 13:26:00' (UTCは日本時間より9時間遅い) */
```

#### 文字列を返す関数
+ `DAYNAME()`関数は指定した日付の曜日の名前を返す。
+ `EXTRACT()`関数は、日付型のデータから年･月･日など必要な部分だけを取り出す。
  - 引数は`(単位) FROM (日付)`のように与える。単位は`DATE_ADD()`関数で使えるものと同様。
  - `MINUTE_SECOND`などを使って複数部分を取り出す際、区切り文字は出力されない。

#### 数値を返す時間関数
+ `DATEDIFF()`関数は、2つの日付の間の日数を計算する。
  - 第1引数の日付から第2引数の日付を引き算するので、古い日付を第1引数にすると結果は負の数になる。

### 型変換関数
+ `CAST()`関数はデータを指定した型に変換する。
  - 引数は`(データ) AS (変換先の型)`のように指定する。
  - 文字列を数値に変換する際は左から順に変換され、途中で数字でない文字が検出されるとそこで変換を中断する。エラーは発生しない。
  - 日付文字列を日付データ型に変換する際は、デフォルトフォーマットを使用する必要がある。

***

[前へ](c5-6.md) /
[全体目次へ戻る](index.md) /
[次へ](c8.md)
