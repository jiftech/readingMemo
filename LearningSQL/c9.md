# 初めてのSQL 第9章
[全体目次へ戻る](index.md)

## 9章 サブクエリ
サブクエリとは、別のSQL文に含まれている、括弧に囲まれたクエリのこと。サブクエリは、返すテーブルの行･列の数によって以下の3つに分類でき、それぞれ使用できる場所が異なる。
  + 1行1列のデータを返すサブクエリ
  + 複数行1列のデータを返すサブクエリ
  + 複数行複数列のデータを返すサブクエリ

また、サブクエリを含む側の文の列を参照するかどうかで｢非相関サブクエリ｣と｢相関サブクエリ｣に分類できる。

### 非相関サブクエリ
非相関サブクエリは、それ単体で実行され、含む側の文の何かを参照しない。

非相関かつ1行1列のテーブルを返すサブクエリを｢スカラーサブクエリ｣と呼び、等価条件･非等価条件を判定する演算子(=, <, >など)とともに利用できる。

```sql
/* 口座IDが全口座の中で最大であるような口座の各情報を取得する。 */
/* 最大の口座IDを取得するのにサブクエリを利用している。このサブクエリはスカラーサブクエリである。 */
SELECT account_id, product_cd, cust_id, avail_balance
FROM account
WHERE account_id = (SELECT MAX(account_id) FROM account);
```

複数行1列のテーブルを返すサブクエリは等価条件･非等価条件の中では使えないが、一部の演算子とともに利用することができる。
+ `IN`演算子は、ある1つの値が値の集合に含まれているかを判定する。この値の集合として複数行1列のテーブルを返すサブクエリを利用できる。
  - `NOT IN`演算子は`IN`演算子の逆。

```sql
/* 他の行員の上司になっている行員の情報を取得する。 */
/* サブクエリで、全ての行員の上司の行員IDのリストを取得し、IN演算子で行員IDがそのリストの中にあるかを判定している。 */
SELECT emp_id, fname, lname, title
FROM employee
WHERE emp_id IN (SELECT superior_emp_id FROM employee);
```

+ `ALL`演算子は、1つの値を集合内の全ての値と比較(=, <, >など)し、全ての値について条件が成り立っていれば残す。集合として複数行1列のテーブルを返すサブクエリを利用できる。
  - `!= ALL(値の集合)`は、`NOT IN(値の集合)`と等価だが、`NOT IN`が好まれる。
+ `ANY`演算子は、1つの値を集合内の全ての値と比較し、どれかの値について条件が成り立っていれば残す。
  - `= ANY(値の集合)`は、`IN(値の集合)`と等価だが、`IN`が好まれる。

```sql
/* Hoge Fugaの持つどの口座よりも残高が少ない口座の情報を取得する。 */
SELECT account_id, cust_id, product_cd, avail_balance
FROM account
WHERE avail_balance < ALL (SELECT a.avail_balance
FROM account a INNER JOIN individual i
ON a.cust_id = i.cust_id
WHERE i.fname = 'Hoge' AND i.lname = 'Fuga');
```

複数行複数列のテーブルを返すサブクエリは、where節内の、括弧で囲まれ順番が指定された複数の列に関する条件の比較対象にできる。条件の列の順番とサブクエリが返すテーブルの列の順番は一致していなければならないことに注意。

```sql
/* 支店IDと口座を開いた行員IDの組が、｢Woburn支店の出納長か出納係｣の支店ID･行員IDの組のリストに含まれていれば結果に残す。 */
/* Woburn支店の出納長か出納係によって開かれた口座の情報を取得することになる。 */
SELECT account_id, product_cd, cust_id
FROM account
WHERE (open_branch_id, open_emp_id) IN
(SELECT b.branch_id, e.emp_id
FROM branch b INNER JOIN employee e
ON b.branch_id = e.assigned_branch_id
WHERE b.name = 'Woburn Branch'
AND (e. title = 'Teller' OR e.title = 'Head Teller'));
```
***

[前へ](c8.md) /
[全体目次へ戻る](index.md) /
[次へ](c10.md)
