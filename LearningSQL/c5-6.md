# 初めてのSQL 第5〜6章
[全体目次へ戻る](index.md)

## 5章 複数テーブルからのデータの取得
1つのクエリで複数のテーブルからデータを取得するためには、結合を使う。

### 内部結合と外部結合
2つ以上のテーブルを、ある列のデータの関係(殆どの場合等価条件)を使ってつなげることを結合という。中でも、一方のテーブルに存在する結合に使う列の値が他方のテーブルの列には存在しない場合に結合に失敗し、その値が含まれる行は結果に含まれないような結合を **内部結合** という。逆に、どちらか一方のテーブルにしか存在しない行も含めるような結合を **外部結合** という。

+ SQL文で内部結合を表現するには`INNER JOIN`キーワードを使い、結合に使う列と条件を`ON`の後に記述する。

```sql
/* 従業員名とその従業員の部署の情報を取得する */
/* 従業員と部署IDを関連付けるemployeeテーブルと 部署IDと部署名を関連付けるdepartmentテーブルを */
/* それぞれの部署IDの値が一致するという条件で内部結合する */
SELECT e.fname, e.lname, d.name
FROM employee e INNER JOIN department d
ON e.dept_id = d.dept_id;
```

+ 2つのテーブルの結合に用いる列の名前が同じ場合`USING`キーワードを使うこともできる。

```sql
/* 処理内容は上の例と同じ */
SELECT e.fname, e.lname, d.name
FROM employee e INNER JOIN department d
USING (dept_id);
```

+ 3つ以上のテーブルを結合する場合は、単純にfrom節に`INNER JOIN ... ON ...`を加えていけば良い。
+ 同じテーブルを2回以上結合することもできるが、この場合は複数回利用されるテーブルにそれぞれ別々の別名を割り当てる必要がある。
+ テーブルをそのテーブル自身と結合することもできる。これを自己結合という。
  - テーブルのある列が、その列が含まれるテーブル自身の主キーを外部キーとして参照しているとき、この列を自己参照外部キーと呼ぶ。このような外部キーが含まれるテーブルを自己結合することが多い。
+ ある列の値同士が等しいという条件で結合することを等結合という。逆に値が等しくない(どちらかの値が他方より大きい･小さい)という条件で結合することを非等結合という。
+ 結合条件は`ON`のあとに、フィルタ条件は`WHERE`のあとに書かれるべきものだが、両方の条件を`ON`のあとまたは`WHERE`に書いてもMySQLサーバは同じ結果を返す。可読性のためには分けて書いたほうが良い。

## 6章 集合
集合演算を使って複数のテーブルを組み合わせることができる。

+ SQLでは、テーブル同士の和集合(union)、共通部分(intersect)、差集合(except)を取ることができる。ただし、MySQLでは共通部分や差集合を求める演算子は実装されていない。
+ MySQLでテーブル同士の和集合を求めるには`UNION`演算子を使う。ただし、`UNION`を使うには以下の条件を満たす必要がある。
  - 和集合をとる2つのテーブルの列の数が等しい
  - テーブルを組み合わせるときに対になる列のデータ型が等しい
+ `UNION`で和集合をとる場合、デフォルトでは重複を削除する。重複を削除せずに残す場合は代わりに`UNION ALL`を使う。

```sql
/* 2つのSELECT文の結果をUNIONで組み合わせる。重複は削除しない */
/* individualテーブルからid, lname(別名: name)をとった結果 + businessテーブルからidとnameをとった結果 */
SELECT id, lname name
FROM individual
UNION ALL
SELECT id, name
FROM business;
```

+ `UNION`などで繋がった複数のクエリ全体を｢複合クエリ｣という。複合クエリの結果を並べ替える場合、最後にorder byを追加すれば良いが、ここで用いる列名は複合クエリの1つ目のクエリに含まれているものでなければならない。
+ 3つ以上のクエリを`UNION`などでつなぐ場合、デフォルトでは上から順番に演算子が適用される。この順番を入れ替えるには、先に演算子を適用したい部分を括弧で囲む。

***

[前へ](c2-4.md) /
[全体目次へ戻る](index.md) /
[次へ](c7.md)
