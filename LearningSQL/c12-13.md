# 初めてのSQL 第12〜13章
[全体目次へ戻る](index.md)

## 12章 トランザクション
複数のユーザが同時にデータベースのデータを読んだり書いたりする際にデータの一貫性を守るための仕組みについて。

### マルチユーザーデータベース
複数のユーザがクエリやデータの変更を実行する状況では、書き込みの競合でデータが破壊されることなく、かつ読み取り時にデータが最新の状態であることが保証されなければならない。そのために、データリソースの同時使用を制御するロック機構を用いる。データベースサーバがロックを処理する際の戦略は大きく2つある。

+ 書き込みを行う際は書き込みロックを、読み取りを行う際は読み取りロックをそれぞれデータベースサーバから取得させる。複数のユーザが同時に読み取ることは可能だが、同時に書き込むことや。読み取り中の書き込み･書き込みの読み取りは禁止する。
+ 書き込みを行う際は書き込みロックを取得する必要があるが、読み取りの際は必要ない。読み取ったデータの整合性はデータベースサーバによって保証される。この手法はバージョニングと呼ばれている。

また、リソースのロック自体も、ロックされるデータの範囲(粒度)によって区別される。

+ テーブルロック: 同じテーブルのデータを同時に変更できないようにする
+ ページロック: 同じページ(記憶領域上の2~16KB程度の区間)のデータを同時に変更できないようにする
+ 行ロック: 同じ行を同時に変更できないようにする

一般にロックされるデータの範囲が広いほど、手間がかからないかわりにユーザ数が増えたときのオーバーヘッドが大きくなる。

MySQLでは、テーブルごとに使うデータベースエンジンを選択でき、利用するエンジンによってロックの戦略や粒度を選択できる。

### トランザクションとは
トランザクションは、複数のSQL文をまとめて｢全てが成功するか、全てが失敗する｣ことを保証する仕組み。トランザクションの処理の流れは以下のようになる。

+ まずトランザクションを開始する。
  - 全ての文の処理が成功した場合｢コミット｣によってトランザクションを終了する。
  - どこかで処理が失敗したり問題が起きた場合は｢ロールバック｣を行う。ロールバックは、トランザクションが開始されてから加えられた変更をすべて元に戻す命令。

また、コミットやロールバックを実行する前にデータベースサーバがシャットダウンした場合は、次の再起動の際に終了していなかったトランザクションを検索し、ロールバックする。

MySQLでは何も指定しない場合はSQL文1つ1つが1つのトランザクションになり、1つの文ごとに自動的にコミットされる。複数の文をトランザクションにまとめるには明示的に`START TRANSACTION`コマンドを発行する必要がある。トランザクションを開始した場合、SQL文でデータを変更しても`COMMIT`コマンドを発行するまでは変更は保存されないが、データを間違えて変更してしまった場合は`ROLLBACK`コマンドでトランザクション開始時点の状態に戻すことができる。

以下のような状況では、トランザクションが自動的に終了する。

+ データベースサーバがシャットダウンした場合、トランザクションは次の再起動時にロールバックされる。
+ `ALTER TABLE`などテーブルの定義を変更するSQLスキーマ文を発行した場合、現在のトランザクションはコミットされ、新しいトランザクションが開始される。
+ トランザクション内で新しい`START TRANSACTION`コマンドを発行した場合、現在のトランザクションは自動的にコミットされて終了する。
+ デッドロックが検出され、その原因がトランザクションだと判断された場合、トランザクションはロールバックされる。

トランザクション内で問題が発生したが、ロールバックによって全ての変更を元に戻すのは避けたいという場合は、トランザクションにセーブポイントを設定する。セーブポイントには名前を付けることができ、必要なときに名前を指定してそのセーブポイントの時点まで変更を戻すことができる。

MySQLでは`SAVEPOINT <名前>`コマンドでセーブポイントを設定でき、`ROLLBACK TO SAVEPOINT <名前>`で指定したセーブポイントの時点まで変更を戻す。

## 13章 インデックスと制約

***

[前へ](c11.md) /
[全体目次へ戻る](index.md) /
