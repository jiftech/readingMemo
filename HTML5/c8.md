# 入門HTML5 8章
[全体目次へ戻る](index.md)
## 目次
[TOC]

## 8章 オフライン状態での動作
### 8.1 はじめに
オフラインWebアプリケーションは、そのアプリケーションのホームページが参照している**マニフェストファイル**に書かれたリソースファイルをオンライン状態でローカルにキャッシュし、オフラインな状態ではそのローカルコピーを参照して動作する。

オフライン状態での変更はローカルに保存し、オンライン状態になったときにリモートサーバと同期する必要があるが、この仕組みはWeb開発者が構築することになる。

### 8.2 キャッシュマニフェスト
オフラインWebアプリケーションの動作に必要なファイルの一覧をマニフェストファイルという。`<html>`要素の`manifest`属性を使ってマニフェストファイルを指定することで、ブラウザはそれに書かれたリソースファイルをダウンロードし、キャッシュするようになる。マニフェストファイルはサーバのどこに置いてもいいが、`text/cache-manifest`というMIMEタイプを使って送信されなければならない。`Content-Type`ヘッダを指定する方法はサーバによるので調べること。拡張子は`.appcache`が推奨されているが、MIMEタイプが正しければなんでも構わない。

Webアプリケーションがいくつかのページにまたがる場合、その全てのページにマニフェストファイルを指定し、全てのページをアプリケーションのリソースとしてマニフェストファイルに書く必要がある。アプリケーションが1つのページで完結する場合はそのページ自身をマニフェストファイルに書く必要はない。

マニフェストファイルの最初の行は`CACHE MANIFEST`となり、それ以降は3つの部分に分かれる。それぞれの部分に対応したヘッダがある。

+ 明示リストセクション: ここに書いたファイルは必ずダウンロードされてローカルにキャッシュされる。
+ NETWORKセクション: キャッシュされるべきでなく、オフライン状態では利用できないファイル。
+ FALLBACKセクション: 2つの場所をスペースで区切って書く。もし前半のファイルがキャッシュされていなかったら、代わりに後半のファイルを読み込む。

例:

```
CACHE MANIFEST
FALLBACK:
/ /offline.html
NETWORK:
*
```

FALLBACKセクションの「`/ /offline.html`」の前半「`/`」は、サイトの全てのページにマッチするURLパターンで、オフラインでサイト内のページを見ようとするとまずキャッシュを探す。もしキャッシュに見ようとしているページがあれば、それを表示し、なければ代わりに「`offline.html`」を表示する。NETWORKセクションの「`*`」は、オンライン状態ではそのWebサイトのページに埋め込まれた画像などのリソースを**別のドメインにあるものであっても関係なく**キャッシュすることを表す。

### 8.3 イベントの流れ
キャッシュマニフェストを参照しているページを読み込んだとき、ブラウザは以下のようなイベントを`window.applicationCache`オブジェクト上に発生させる。

1. `checking`イベントを発生させる。このイベントは過去にこのページを訪れたことがあるかないかにかかわらず、必ず発生する
2. はじめての訪問だった場合
    + `downloading`イベントを発生させ、キャッシュマニフェストに記載されたリソースのダウンロードを始める
    + ダウンロード中は定期的に`progress`イベントを発生させる。ダウンロード済みファイル数と総ファイル数の情報が含まれている
    + 全てのダウンロードが成功したら`cached`イベントを発生させる(終)
3. 過去に訪れたことがあった場合
    + 以前の訪問時からキャッシュマニフェストが変わっていなかった場合は`noupdate`イベントを発生させる(終)
    + キャッシュマニフェストが変化していた場合は、`downloading`イベントを発生させ、リソースの再ダウンロードを開始
        - ダウンロード中は`progress`イベントを発生させる
        - 全てのダウンロードが成功したら`updateready`イベントを発生させる。この状態ではアプリケーションは最新の状態にはなっておらず、`window.applicationCache.swapCache()`関数を呼ぶことで新しいバージョンにスワップさせることができる

キャッシュマニフェストが見つからない、キャッシュマニフェストを参照するページが読み込めない、リソースのダウンロードに失敗したなどのエラーが発生した場合は、`error`イベントを発生させる。

### 8.4 デバッグの手法
`error`イベントにはエラーの詳細が含まれないので、オフラインWebアプリケーションのデバッグはつらいよ

また、エラーが起きていなくても思い通りに動かない場合がある。それはブラウザがキャッシュマニフェストが更新されたかをチェックする以下の手順を理解しないと気づきにくい。

1. ブラウザはキャッシュマニフェストが期限切れになっているかをチェックする。
2. 期限切れになっている場合は、サーバーに新しいバージョンのファイルがあるか問い合わせ、あればダウンロードする。サーバーは、マニフェストファイルに変更がないと判断するとその旨を`304 Not Modified`ステータスコードとしてブラウザに伝える
3. サーバーがマニフェストファイルが変更されたと判断した場合は、新しいマニフェストファイルを送信する。

キャッシュマニフェスト(に限らず様々なリソースファイル)は、標準では数時間キャッシュされるので、そのキャッシュの期限が切れる前にマニフェストファイルを変更しても、ブラウザはキャッシュされたマニフェストファイルを読み込んでしまい、変更の内容が反映されない、ということが起こる。この問題を回避するには、Webサーバの設定を変更してマニフェストファイルがキャッシュされないようにする。ApacheベースのWebサーバを使っている場合は`.htaccess`ファイルに以下の2行を追加すればよい。

```
ExpiresActive On
ExpiresDefault "access"
```

また、リソースに変更があっても、そのリソースのURLが変わらない場合は、キャッシュマニフェストにも変更がないのでブラウザはリソースの変更に気付かない。この問題を回避するには、キャッシュマニフェストにコメントでリビジョン番号を書き、リソースが変更されたらリビジョン番号も更新するようにすればよい。

```
CACHE MANIFEST
# rev 42
***.js
...
```

### 8.5 実際に作ってみる
[オフラインでも動くハルマゲーム](http://diveintohtml5.info/examples/offline/halma.html)

***

[前へ](c7.md) / [全体目次へ戻る](index.md) / [次へ](c9.md)
