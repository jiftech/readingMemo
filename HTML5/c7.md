# 入門HTML5 7章
[全体目次へ戻る](index.html)
## 目次
[TOC]

## 7章 Webアプリケーションのローカルストレージ
### 7.1 はじめに
Cookieは、少量のデータであれば永続的なローカルストレージとして利用可能だが、全てのHTTPリクエストに含まれるため速度の低下やセキュリティ面の不安といった問題が発生する上、データ容量の上限が4KBしかない。Webアプリケーションのローカルストレージに必要だったのは、ページを更新しても消えず、サーバーに送信されることのない、クライアント上に設けられた、大量のストレージ領域であった。

### 7.2 HTML5以前
HTML5以前はいろんな会社がいろんなインターフェースを作って大変だったよという話

### 7.3 HTML5ストレージ入門
HTML5ストレージとは、Webページがブラウザからキーと値のペアに名前をつけてローカルに保存する方法。実際には「Web Storage」という名前。サイトを離れたり、ブラウザを終了したりしても保持され、Cookieとは違いデータがWebサーバに送信されることはない。

JavaScriptからローカルストレージにアクセスするには、`window`オブジェクト上の`localStorage`オブジェクトを使う。

### 7.4 HTML5ストレージの使用
基本は「名前付きキー」と「値(データ)」の組。キーは文字列で、値はJavaScriptで使える全ての型のデータが使えるが、保存されるときは全て文字列として保存されるので、値を取り出すときにもとの型に変換する必要がある。

`localStorage`の`getItem(key)`でキーに対応する値を取り出し(存在しないキーを渡すとnullが返る)、`setItem(key, data)`で新しいキーと値の組を追加する(既にあるキーを指定すると値が上書きされる)。`localStorage`オブジェクトは連想配列として扱える。以下のように値を設定・取得できる。

```js
// メソッドを使う場合
var foo = localStorage.getItem("bar");
localStorage.setItem("bar", foo);

// 連想配列のように角括弧を使うこともできる
var foo = localStorage["bar"];
localStorage["bar"] = foo;
```

他にも以下のようなプロパティ・メソッドがある。

|プロパティ・メソッド       |機能                       |
|:-------------------       |:---                       |
|removeItem(key)            |keyに対応する値を削除する  |
|clear()                    |全てのキーと値を削除する   |
|length                     |ストレージ中の値の総数     |
|key(index)                 |index番目のキーの名前を取得|

#### 7.4.1 HTML5ストレージの変化を検出する
値が追加・削除されたといったストレージの変化を検出するには、`window`オブジェクト上で発生する`storage`イベントを捕捉すればよい。値を変化させるメソッドが呼ばれたとしても、「実際に何かが変化」しなければこのイベントは発生しない。

```js
if(window.addEventListener){
  window.addEventListener("storage", handle_storage, false);
}
// IE8はaddEventListenerをサポートしていないので、別の方法を使う
else {
  window.attachEvent("onstorage", handle_storage);
}
...
function handle_storage(e){
  // IEではイベントはコールバック関数に渡されず、window.eventに保存される
  if (!e){
    e = window.event;
  }
  ...
}
```

上コード例の`e`は`StorageEvent`オブジェクトであり、次のようなプロパティを持つ。

|プロパティ|説明|
|:---------|:---|
|key       |追加・削除・変更されたキー                           |
|oldValue  |上書きの場合、上書きされる前の値。追加の場合はnull   |
|newValue  |新しい値。削除の場合はnull                           |
|url       |この変化を引き起こしたメソッドを呼び出したページのURL|

#### 7.4.2 制限
ストレージの容量の制限は5MBである。この制限を超えた場合には`QUOTA_EXCEEDED_ERR`という例外が発生する。ストレージの容量を拡大することは今のところ不可能である。

### 7.5 HTML5ストレージの実例
[ハルマゲームの盤面状態を保存する例](http://diveintohtml5.info/storage.html#halma)

### 7.6 名前付きキーと値のペアを超えて:競合する構想
Web Storageの次のローカルストレージの構想として「Web SQL Database」というJavaScriptからSQLデータベースを操作できるような仕組みが考えられていたが、策定は停止された
。

もうひとつの先進的なWebアプリケーション向けローカルストレージの構想として「Indexed Database API」がある。これはオブジェクトストアという仕組みを表現したもので、構造的にはSQLデータベースと似た概念が多いが、SQL文のようなクエリを使うのではなく、オブジェクトストアのメソッドを使ってデータを取得する。

***

[前へ](c6.html) / [全体目次へ戻る](index.html) / [次へ](c8.html)