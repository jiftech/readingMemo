# リーダブルコード 第5章
[全体目次へ戻る](index.md)

## 5章 コメントすべきことを知る
コメントの目的は、**書き手の意図を読み手に知らせること** である。

## 5.1 コメントするべきでは｢ない｣こと
コメントを読む時間だけコードを読む時間が減るし、コメントは画面を占領する。言い換えれば、コメントにはそれだけの価値をもたせるべき。

**コードを読むだけで｢すぐに｣分かること** をコメントに書くのは無価値。新しい情報を提供しないコメントでも、コードを読むよりコメントを読むほうが理解が早くなるなら価値はある。

### コメントのためのコメントをしない
関数の名前と引数を文章形式でコメントに書き直すのは無価値。

```cpp
/* 価値のないコメント */
// 与えられたsubtreeに含まれるnameとdepthに合致したNodeを見つける。
Node* FindNodeInSubTree(Node* subtree, string name, int depth);

/* 改善例 */
// 与えられた'name'の合致したNodeかNULLを返す。
// もしdepth <= 0 ならば、'subtree'だけを調べる。
// もしdepth == N ならば、'subtree'とその下のN階層まで調べる。
```

### ひどい名前はコメントをつけずに名前を変える
関数名の意味を説明するだけのコメントをつけるなら、先に関数名を分かりやすくするべき。関数名はコメントよりも目にする回数が多いため。

```cpp
/* 'Clean'の意味を説明するだけの無価値なコメント */
// Replyに対してRequestで記述した制限を課す。
void CleanReply(Request request, Reply reply);

/* 改善: まず関数名を説明的にする */
// 'reply'を'request'にある項目数やバイト数の制限に合わせる。
void EnforceLimitsFromRequest(Request request, Reply reply);
```

通常はコードの読みにくさを補う｢補助的なコメント｣が必要になることはない。**｢優れたコード > ひどいコード + 優れたコメント｣**

## 5.2 自分の考えを記録する
優れたコメントとは、コードを書いているときに持っている｢大切な考え｣を記録するものである。

### 監督のコメンタリーを入れる
映画のDVDのコメンタリーのように、コードの製作者はコードに対する大切な考えをコメントとして記録するべきである。

例) このようなコメントを見れば、下手に最適化しようとして時間を無駄にすることはなくなる。
```c
// このデータだとハッシュテーブルよりもバイナリツリーのほうが40%速かった。
// 左右の比較よりもハッシュの計算コストのほうが高いようだ。
```

例) 失敗するテストケースに時間をかけたり、バグと勘違いすることがなくなる。
```c
// ヒューリスティックだと単語が漏れることがあるが仕方ない。
```

例) コードが汚いこととその理由をコメントに書き、誰かに修正を促すことができる。
```c
// このクラスは汚くなってきている。
// サブクラス'ResourceNode'を作って整理したほうがいいかもしれない。
```

### コードの欠陥にコメントをつける
欠陥をコメントとして文書化することで、改善すべき箇所を目立たせることができる。このとき、例えば`TODO:`のような記法がよく使われる。

|記法    |典型的な意味|
|:-------|:-----------|
|`TODO:` |あとで手を付ける|
|`FIXME:`|既知の不具合がある|
|`HACK:` |あまりキレイじゃない解決策|
|`XXX:`  |大きな問題がある、危険|

### 定数にコメントをつける
定数を定義するときには、それがなぜその値を持っているのか、という｢背景｣が存在する場合が多い。その背景をコメントにすることで、書き手の考えが伝わりやすくなる。

例)
```py
NUM_THREADS = 8 # 値は｢>= 2 * num_processors｣で十分。
```

## 5.3 読み手の立場になって考える
プロジェクトを熟知していない人に、コードがどのように見えるかを想像する技法は、どこにコメントをつければいいかを判断するのに役立つ。

つまり、他人がコードを読んで疑問に思うであろう箇所にコメントをつければいい。

```cpp
struct Recorder {
    vector<float> data;
    ...
    void Clear() {
        // どうしてdata.clear()しないの? -> vectorのメモリを開放する方法がこれしかないから
        // ベクタのメモリを開放する
        vector<float>().swap(data)
    }
}
```

### ハマりそうな罠を告知する
関数やクラスを｢どんなふうに間違えて使う可能性があるだろう?｣と自問し、問題を前もって予測し、コメントで告知する。

例) 壊れたHTMLを修復する関数。ネストが深いと処理に時間がかかる。ユーザが使う前に、この問題について告知するべき。
```py
# 実行時間はO(タグの数 * タグの深さの平均)なので、ネストの深さに気をつける。
def FixBrokenHtml(html): ...
```

### ｢全体像｣のコメント
新しくチームに参加した人にとって最も難しい、コードの｢全体像｣の理解を助けるために、ファイルやクラスなど高レベルの対象にデータの流れ、クラスの連携、エントリーポイントなどの情報をコメントとして書き残すようにする。

### 要約コメント
関数の内部のコードの塊のような低レベルの要素にも、動作を要約するようなコメントをつけるとよい。

```py
def GenerateUserReport():
  # このユーザのロックを獲得する
  ...

  # ユーザの情報をDBから読み込む
  ...

  # 情報をファイルに書き出す
  ...

  # このユーザのロックを開放する
  ...
```

## 5.4 ライターズブロックを乗り越える
コメントを書くのに行き詰まってしまう｢ライターズブロック｣を乗り越えるには、とにかく書き始めるしかない。コードを書いている途中に考えていることをそのまま書き出してみる。

例) ｢ヤバい。これはリストに重複があったら面倒なことになる｣と思ったら、とりあえずそのままコメントに書き出してみる。その後で言い回しを詳細な言葉に置き換えていけばよい。
- ｢ヤバい｣は｢注意、気をつけて｣という意味
- ｢これ｣は｢入力を処理するコード｣
- ｢面倒なことになる｣とは｢実装が難しくなる｣ということ

上のコメントを書き換えると｢注意: このコードはリストの重複を処理できません(実装が難しいため)｣のようになる。

コメントを書く作業は、3つの簡単な手順に分解できる。
1. 頭の中にあるコメント(考え)をとにかく書き出す。
2. 改善が必要な言葉を見つける。
3. 改善する。

***

[前へ](c4.md) /
[全体目次へ戻る](index.md) /
[次へ](c6.md)
